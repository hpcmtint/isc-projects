<app-breadcrumbs [items]="breadcrumbs">
    <div page-help>
        <p>
            This page displays a list of all machines that have been configured in Stork. It allows adding new machines
            as well as removing them.
        </p>
    </div>
</app-breadcrumbs>

<p-dialog header="New Machine" [(visible)]="newMachineDlgVisible" [style]="{ width: '40vw' }">
    <p style="padding-bottom: 1em">
        First, install Stork Agent on the machine with Kea or BIND 9. This is described in
        <a target="blank" href="/assets/arm/index.html#agent-deploy"
            >the Stork Agent instructions<i class="pi pi-external-link" style="font-size: 1em"></i></a
        >.
    </p>

    <p style="padding-bottom: 1em">
        Machine is located by address and port where 'address' is the IP address or FQDN of machine, and port is the
        Stork Agent listening port. Port can be omitted; default value is 8080.
    </p>
    <div>
        Address:
        <input
            type="text"
            style="width: 100%"
            pInputText
            [(ngModel)]="machineAddress"
            id="machineAddress"
            (keyup)="keyUpMachineDlg($event, null)"
        />
    </div>
    <div style="margin-top: 10px">
        Port:
        <input
            type="text"
            style="width: 100%"
            placeholder="8080"
            pInputText
            [(ngModel)]="agentPort"
            id="agentPort"
            (keyup)="keyUpMachineDlg($event, null)"
        />
    </div>
    <p-footer>
        <button
            type="button"
            id="cancelMachineDialog"
            (click)="cancelMachineDialog()"
            pButton
            icon="pi pi-times"
            label="Cancel"
        ></button>
        <button
            type="button"
            id="addNewMachine"
            (click)="addNewMachine()"
            pButton
            icon="pi pi-check"
            label="Add"
        ></button>
    </p-footer>
</p-dialog>

<p-dialog header="Change Machine Address" [(visible)]="changeMachineAddressDlgVisible" [style]="{ width: '30vw' }">
    <p style="padding-bottom: 1em">
        Stork server will be using the new address and/or port to communicate with this machine. Please ensure that the
        agent running on the machine is using this new address and/or port to avoid communication problems.
    </p>
    <div>
        Address:
        <input
            type="text"
            style="width: 100%"
            pInputText
            [(ngModel)]="machineAddress"
            (keyup)="keyUpMachineDlg($event, machineTab)"
        />
    </div>
    <div style="margin-top: 10px">
        Port:
        <input
            type="text"
            style="width: 100%"
            placeholder="8080"
            pInputText
            [(ngModel)]="agentPort"
            (keyup)="keyUpMachineDlg($event, machineTab)"
        />
    </div>
    <p-footer>
        <button type="button" (click)="cancelMachineDialog()" pButton icon="pi pi-times" label="Cancel"></button>
        <button
            type="button"
            (click)="saveMachine(machineTab)"
            pButton
            icon="pi pi-check"
            label="Change"
            class="ui-button-warning"
        ></button>
    </p-footer>
</p-dialog>

<p-tabMenu [model]="tabs" [activeItem]="activeItem" [style]="{ 'margin-top': '10px' }">
    <ng-template pTemplate="item" let-item let-i="index">
        <div style="display: flex; justify-content: space-between">
            <div class="ui-menuitem-icon" [ngClass]="item.icon" *ngIf="item.icon" style="font-size: 2em"></div>
            <div class="ui-menuitem-text">
                <b>{{ item.label }}</b>
            </div>
            <div
                class="ui-menuitem-icon pi pi-times"
                style="font-size: 1.3rem"
                (click)="closeTab($event, i)"
                *ngIf="i !== 0"
            ></div>
        </div>
    </ng-template>
</p-tabMenu>

<!-- Machines tab -->
<div *ngIf="activeTabIdx == 0">
    <div style="display: flex; justify-content: space-between; margin: 10px">
        <div>
            <span>
                <i class="fa fa-search" style="margin: 4px 4px 0 0"></i>
                Filter machines:
                <input
                    type="text"
                    id="filterMachinesTextField"
                    pInputText
                    [(ngModel)]="filterText"
                    placeholder="name or any other field"
                    (keyup)="keyUpFilterText(machinesTable, $event)"
                />
                <app-help-tip title="filtering">
                    <p>
                        Machines in the table below can be filtered by entering a text in the search box; the table
                        shows all machines matching the filter text. Currently supported fields for such filtering are:
                    </p>
                    <ul>
                        <li>Address</li>
                        <li>Agent Version</li>
                        <li>Hostname</li>
                        <li>OS</li>
                        <li>Platform</li>
                        <li>Platform Family</li>
                        <li>Platform Version</li>
                        <li>Kernel Version</li>
                        <li>Kernel Arch</li>
                        <li>Virtualization System</li>
                        <li>Virtualization Role</li>
                        <li>Host ID</li>
                    </ul>
                    <p>
                        The search is performed while typing or on pressing Enter. The minimum number of search
                        characters is 2.
                    </p>
                </app-help-tip>
            </span>
            <!-- <span style="margin-left: 40px;"> -->
            <!--   App: -->
            <!--   <p-dropdown [options]="appTypes" [(ngModel)]="selectedAppType" optionLabel="name" (onChange)="filterByApp(machinesTable)"></p-dropdown> -->
            <!-- </span> -->
        </div>

        <div style="display: flex">
            <button
                type="button"
                pButton
                label="Add New Machine"
                icon="pi pi-plus"
                style="margin-right: 20px"
                (click)="showNewMachineDlg()"
            ></button>
            <button
                type="button"
                pButton
                label="Refresh"
                id="Refresh"
                icon="pi pi-refresh"
                (click)="refreshMachinesList(machinesTable)"
            ></button>
        </div>
    </div>

    <p-menu #machineMenu [popup]="true" [model]="machineMenuItems"></p-menu>
    <p-table
        #machinesTable
        [value]="machines"
        [paginator]="true"
        [rows]="10"
        [lazy]="true"
        (onLazyLoad)="loadMachines($event)"
        [totalRecords]="totalMachines"
        [rowsPerPageOptions]="[10, 30, 100]"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="{currentPage} of {totalPages} pages"
    >
        <ng-template pTemplate="emptymessage" let-columns>
            <tr>
                <td colspan="12">
                    No machines found.
                    <br />
                    <br />
                    Machines can be added by clicking the <b>Add New Machine</b> button at the top.
                </td>
            </tr>
        </ng-template>
        <ng-template pTemplate="header">
            <tr>
                <th style="width: 8rem">Hostname</th>
                <th style="width: 10rem">
                    Location
                    <app-help-tip title="Location">
                        <p>
                            Specifies where the server can reach the agent as a hostname:tcp-port pair (e.g.
                            localhost:8888).
                        </p></app-help-tip
                    >
                </th>
                <th style="width: 4.5rem">Agent Version</th>
                <th style="width: 7rem">Daemons</th>
                <th style="width: 4rem">CPUs</th>
                <th style="width: 8rem">
                    CPU Load
                    <app-help-tip title="CPU Load">
                        <p>
                            These three numbers are CPU load averages for last 1 minute, 5 minutes and 15 minutes. This
                            is the usual syntax used by <b>top</b> command.
                        </p>

                        <p>
                            High load averages imply that a system is overloaded. A value of 1.00 means one CPU core is
                            fully utilized. For example, if your system has load of 1.22 and you have only 1 CPU core,
                            the system is overloaded. However, if there are 4 cores, you system is working at a bit over
                            30% of its capacity.
                        </p>
                    </app-help-tip>
                </th>
                <th style="width: 5rem">Total Memory [GB]</th>
                <th style="width: 7rem">Memory Usage [%]</th>
                <th class="hiding-column" style="width: 6rem">Uptime</th>
                <th class="hiding-column" style="width: 6rem">
                    Last Refreshed
                    <app-help-tip title="Last refreshed"
                        ><p>
                            When the machine status was last retrieved. You can refresh it by clicking Refresh in the
                            Action menu.
                        </p></app-help-tip
                    >
                </th>
                <th style="width: 13rem">Error</th>
                <th style="width: 4rem">Action</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-m>
            <tr class="alternate-list">
                <td>
                    <a routerLink="/machines/{{ m.id }}">{{ m.hostname || m.address }}</a>
                </td>
                <td>{{ m.address }}:{{ m.agentPort }}</td>
                <td>{{ m.agentVersion }}</td>
                <td>
                    <div *ngFor="let a of m.apps">
                        <app-app-daemons-status [app]="m.apps[0]"></app-app-daemons-status>
                    </div>
                </td>
                <td>{{ m.cpus }}</td>
                <td>{{ m.cpusLoad }}</td>
                <td>{{ m.memory }}</td>
                <td><p-progressBar [value]="m.usedMemory"></p-progressBar></td>
                <td class="hiding-column">{{ m.uptime || '?' }} days</td>
                <td class="hiding-column">{{ m.lastVisitedAt | localtime }}</td>
                <td>
                    <p-message *ngIf="m.error" severity="error" text="{{ m.error }}"></p-message>
                </td>
                <td>
                    <button
                        type="button"
                        pButton
                        icon="pi pi-bars"
                        (click)="showMachineMenu($event, machineMenu, m)"
                    ></button>
                </td>
            </tr>
        </ng-template>
        <ng-template pTemplate="paginatorright" let-state>
            Total: {{ state.totalRecords > 0 ? state.totalRecords : '0' }}
            {{ state.totalRecords === 1 ? 'machine' : 'machines' }}
        </ng-template>
    </p-table>
</div>

<!-- Single machine tab -->
<div *ngIf="activeTabIdx != 0" class="ui-widget">
    <div class="p-grid" style="width: 100%">
        <div class="p-col-12" style="display: flex">
            <div style="font-size: 1.8em; font-weight: bold; margin-left: 10px; color: #007ad9">
                <i class="fa fa-server" style="padding-right: 10px"></i> {{ machineTab.machine.address
                }}<span style="color: #007ad930">:{{ machineTab.machine.agentPort }}</span>
                <i
                    class="pi pi-pencil"
                    style="vertical-align: text-top; margin-left: 15px; color: #aaa; cursor: pointer"
                    (click)="editAddress(machineTab)"
                ></i>
            </div>

            <div style="margin-left: 10em">
                <p-message
                    *ngIf="machineTab.machine.error"
                    severity="error"
                    text="{{ machineTab.machine.error }}"
                ></p-message>
            </div>
        </div>

        <div class="p-col-4">
            <h3>System Information</h3>
            <table [ngStyle]="{ color: machineTab.machine.error ? '#999' : '' }">
                <tr>
                    <td>Address</td>
                    <td>{{ machineTab.machine.address }}:{{ machineTab.machine.agentPort }}</td>
                </tr>
                <tr>
                    <td>Hostame</td>
                    <td>{{ machineTab.machine.hostname }}</td>
                </tr>
                <tr>
                    <td>Agent Version</td>
                    <td>{{ machineTab.machine.agentVersion }}</td>
                </tr>
                <tr>
                    <td>CPUs</td>
                    <td>{{ machineTab.machine.cpus }}</td>
                </tr>
                <tr>
                    <td>
                        CPUs Load
                        <app-help-tip title="CPU Load">
                            <p>
                                These three numbers are CPU load averages for last 1 minute, 5 minutes and 15 minutes.
                                This is the usual syntax used by <b>top</b> command.
                            </p>

                            <p>
                                High load averages imply that a system is overloaded. A value of 1.00 means one CPU core
                                is fully utilized. For example, if your system has load of 1.22 and you have only 1 CPU
                                core, the system is overloaded. However, if there are 4 cores, you system is working at
                                a bit over 30% of its capacity.
                            </p>
                        </app-help-tip>
                    </td>
                    <td>{{ machineTab.machine.cpusLoad }}</td>
                </tr>
                <tr>
                    <td>Memory</td>
                    <td>{{ machineTab.machine.memory || '?' }} GiB</td>
                </tr>
                <tr>
                    <td>Used Memory</td>
                    <td>{{ machineTab.machine.usedMemory }} %</td>
                </tr>
                <tr>
                    <td>Uptime</td>
                    <td>{{ machineTab.machine.uptime || '?' }} days</td>
                </tr>
                <tr>
                    <td>OS</td>
                    <td>{{ machineTab.machine.os }}</td>
                </tr>
                <tr>
                    <td>Platform Family</td>
                    <td>{{ machineTab.machine.platformFamily }}</td>
                </tr>
                <tr>
                    <td>Platform</td>
                    <td>{{ machineTab.machine.platform }}</td>
                </tr>
                <tr>
                    <td>Platform Version</td>
                    <td>{{ machineTab.machine.platformVersion }}</td>
                </tr>
                <tr>
                    <td>Kernel Version</td>
                    <td>{{ machineTab.machine.kernelVersion }}</td>
                </tr>
                <tr>
                    <td>Kernel Arch</td>
                    <td>{{ machineTab.machine.kernelArch }}</td>
                </tr>
                <tr>
                    <td>Virtualization Role</td>
                    <td>{{ machineTab.machine.virtualizationRole }}</td>
                </tr>
                <tr *ngIf="machineTab.machine.virtualizationRole == 'guest'">
                    <td>Virtualization System</td>
                    <td>{{ machineTab.machine.virtualizationSystem }}</td>
                </tr>
                <tr>
                    <td>Host ID</td>
                    <td>{{ machineTab.machine.hostID }}</td>
                </tr>
                <tr>
                    <td>Last Visited</td>
                    <td>{{ machineTab.machine.lastVisitedAt | localtime }}</td>
                </tr>
            </table>

            <button
                type="button"
                pButton
                label="Get Latest State"
                icon="pi pi-refresh"
                style="margin-top: 20px"
                (click)="refreshMachineState(machineTab)"
            ></button>
        </div>
        <div class="p-col-4">
            <h3>Applications</h3>
            <div *ngFor="let app of machineTab.machine.apps">
                <h4 *ngIf="app.type == 'kea'">Kea App</h4>
                <h4 *ngIf="app.type == 'bind9'">BIND 9 App</h4>
                <a routerLink="/apps/{{ app.type }}/{{ app.id }}">Version {{ app.version }}</a>
                <br />
                <app-app-daemons-status [app]="app"></app-app-daemons-status>
            </div>
        </div>
        <div class="p-col-4">
            <h3>Events</h3>
            <app-events-panel #eventsTable [filter]="{ machine: machineTab.machine.id }"></app-events-panel>
        </div>
    </div>
</div>
